<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReviewService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend-desapp-api</a> &gt; <a href="index.source.html" class="el_package">ar.edu.unq.desapp.grupoj.backenddesappapi.service</a> &gt; <span class="el_source">ReviewService.java</span></div><h1>ReviewService.java</h1><pre class="source lang-java linenums">package ar.edu.unq.desapp.grupoj.backenddesappapi.service;
import ar.edu.unq.desapp.grupoj.backenddesappapi.config.MessagingConfig;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.*;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.titles.Title;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.user.Critic;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.user.User;
import ar.edu.unq.desapp.grupoj.backenddesappapi.repository.*;
import ar.edu.unq.desapp.grupoj.backenddesappapi.service.dtos.*;
import ar.edu.unq.desapp.grupoj.backenddesappapi.service.exceptions.*;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.data.domain.Page;
import org.springframework.stereotype.Service;

import javax.transaction.Transactional;
import java.util.List;

@Service
public class ReviewService {

    @Autowired
    private  ReviewRepository reviewRepo;

    @Autowired
    private  LanguageService languageSrvc;

    @Autowired
    private TitleService titleService;

    @Autowired
    private UserService userService;

    @Autowired
    private CriticService criticService;

    @Autowired
    private ReportRepository reportRepo;


    @Autowired
    private UserRepository userRepo;

    @Autowired
    private SourceRepository sourceRepo;

    @Autowired
    private LocationRepository locationRepo;

    @Autowired
    private ReviewCriteriaRepository reviewCriteriaRepository;

    @Autowired
    private RabbitTemplate template;


<span class="nc" id="L58">    public ReviewService(){ }</span>

    @EventListener
    public void appReady(ApplicationReadyEvent event) {
/*
        save(new ReviewDTO(1, &quot;Maso, para un domingo zafa&quot;,&quot;pochoclera&quot;,3,true,language));
        User user = new User (source,&quot;fernando.test@gmail.com&quot;,&quot;Fernando&quot;,location);
        user.addReview(new Review(1, &quot;Maso, para un domingo zafa&quot;,&quot;pochoclera&quot;,3,true,language));
        Language language2 = new Language(&quot;English&quot;);

        user.addReview(new Review(3, &quot;Muy mala pelicula&quot;,&quot;No la entendi&quot;,1,true,language));
        user.addReview(new Review(5, &quot;Pectacular, alta peli pero muy larga!&quot;,&quot;Increibles efecto especiales&quot;,3,false,language));

        //userRepository.save(user);


        Critic critic = new Critic(3,&quot;criticoEspecialista@yahoo.com&quot;);
        critic.addReview(new ReviewPremium(4, &quot;La mas pior!&quot;,&quot;Terriblemente aburrida.&quot;,5,true, language2));
        criticRepository.save(critic);
*/
<span class="nc" id="L78">    }</span>

    public List&lt;Review&gt; findAll() {
<span class="nc" id="L81">        return reviewRepo.findAll();</span>
    }

    public List&lt;Review&gt; findAllByIdTitle(Integer idTitle) throws NonExistentTitleException {
<span class="nc" id="L85">        Title title = titleService.getByTitleId(idTitle);</span>
<span class="nc" id="L86">        return reviewRepo.findAllByTitleId(title.getTitleId());</span>
    }

    @Transactional
    public Review save(ReviewDTO aReview) throws NonExistentLocationException, NonExistentLanguageException, NonExistentSourceException, NonExistentTitleException, UserAlreadyReviewTitle {
<span class="nc" id="L91">        Language language= checkLanguage(aReview.getLanguageId());</span>
<span class="nc" id="L92">        User user = userService.getBySourceAndUserIdAndNickId(aReview.getUser().getSourceId(),</span>
<span class="nc" id="L93">                                                            aReview.getUser().getUserId(),</span>
<span class="nc" id="L94">                                                            aReview.getUser().getUserNick(),</span>
<span class="nc" id="L95">                                                            aReview.getUser().getLocationId());</span>

<span class="nc" id="L97">        Review review = aReview.toModel(language,user);</span>
<span class="nc" id="L98">        this.checkUniqueReviewer(review,user);</span>
<span class="nc" id="L99">        reviewRepo.save(review);</span>

<span class="nc" id="L101">        titleService.addReviewToTitle(review,aReview.getTitleId());</span>
<span class="nc" id="L102">        publishReview(aReview);</span>

<span class="nc" id="L104">        return review;</span>
    }

    private void checkUniqueReviewer(Review review, Critic user) throws UserAlreadyReviewTitle {
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (reviewRepo.findReviewsByTitleIdAndUser(review.getTitleId(),user).size()&gt;0) {</span>
<span class="nc" id="L109">            throw new UserAlreadyReviewTitle(review.getTitleId(), user.getUniqueIdString());</span>
        }
<span class="nc" id="L111">    }</span>


    @Transactional
    public Review savePremium(ReviewPremiumDTO aReview) throws NonExistentSourceException, NonExistentTitleException, NonExistentLanguageException, UserAlreadyReviewTitle, NonExistentLocationException, NonExistentCriticException {
<span class="nc" id="L116">        Language language= checkLanguage(aReview.languageId);</span>

<span class="nc" id="L118">        Critic critic = criticService.getBySourceAndCriticId(aReview.critic.getSourceId(),aReview.critic.getUserId(),aReview.critic.getLocationId());</span>


<span class="nc" id="L121">        ReviewPremium review = aReview.toModel(language,critic);</span>
<span class="nc" id="L122">        this.checkUniqueReviewer(review,critic);</span>
<span class="nc" id="L123">        reviewRepo.save(review);</span>

<span class="nc" id="L125">        titleService.addReviewToTitle(review,aReview.titleId);</span>
<span class="nc" id="L126">        publishPremiumReview(aReview);</span>
<span class="nc" id="L127">        return review;</span>

    }

    @Transactional
    public Rates rate(RateDTO rateDto) throws NonExistentReviewException, NonExistentSourceException, NonExistentLocationException {
<span class="nc" id="L133">        Review aReview= reviewRepo.findById(rateDto.reviewId).orElseThrow(() -&gt; new NonExistentReviewException(rateDto.reviewId));</span>
<span class="nc" id="L134">        this.rateReview(aReview,rateDto.user,rateDto.rateType);</span>
<span class="nc" id="L135">        reviewRepo.save(aReview);</span>

<span class="nc" id="L137">        return aReview.getReviewRate();</span>
    }

    private void rateReview(Review review, UserDTO user, RateType rateType) throws NonExistentLocationException, NonExistentSourceException {
<span class="nc" id="L141">        User rateUser = userService.getBySourceAndUserIdAndNickId(user.getSourceId(),</span>
<span class="nc" id="L142">                                                                    user.getUserId(),</span>
<span class="nc" id="L143">                                                                    user.getUserNick(),</span>
<span class="nc" id="L144">                                                                    user.getLocationId());</span>
<span class="nc" id="L145">        review.addRate(new ReviewRate(rateType,rateUser,review));</span>
<span class="nc" id="L146">    }</span>


    @Transactional
    public ReviewReport report(ReportDTO reportDto) throws NonExistentReviewException, NonExistentLocationException, NonExistentSourceException {
<span class="nc" id="L151">        Review aReview= reviewRepo.findById(reportDto.reviewId).orElseThrow(() -&gt; new NonExistentReviewException(reportDto.reviewId));</span>
<span class="nc" id="L152">        User user= userService.getBySourceAndUserIdAndNickId(reportDto.user.getSourceId(),</span>
<span class="nc" id="L153">                                                            reportDto.user.getUserId(),</span>
<span class="nc" id="L154">                                                            reportDto.user.getUserNick(),</span>
<span class="nc" id="L155">                                                            reportDto.user.getLocationId());</span>
<span class="nc" id="L156">        ReviewReport report= new ReviewReport(reportDto.reason,user);</span>
<span class="nc" id="L157">        reportRepo.save(report);</span>

<span class="nc" id="L159">        aReview.addReport(report);</span>
<span class="nc" id="L160">        reviewRepo.save(aReview);</span>
<span class="nc" id="L161">        return report;</span>
    }


    private Language checkLanguage(Integer languageId) throws NonExistentLanguageException {
<span class="nc" id="L166">        return languageSrvc.getById(languageId);</span>
    }

    public Page&lt;Review&gt; getReviews(ReviewPage reviewPage, ReviewSearchCriteria reviewSearchCriteria){
<span class="nc" id="L170">        return reviewCriteriaRepository.findAllWithFilters(reviewPage, reviewSearchCriteria);</span>

    }

    public List&lt;ReviewReport&gt; findAllReports() {
<span class="nc" id="L175">        return reportRepo.findAll();</span>
    }


    public void publishReview (ReviewDTO aReview){
        try{
<span class="nc" id="L181">                ReviewNotification notification = new ReviewNotification(aReview, &quot;new review &quot; );</span>
<span class="nc" id="L182">                template.convertAndSend(MessagingConfig.EXCHANGE, MessagingConfig.ROUTING_KEY, aReview.getTitleId());</span>
<span class="nc" id="L183">        }catch (Exception e){</span>
            //nothing to do
<span class="nc" id="L185">        }</span>
<span class="nc" id="L186">    }</span>
    public void publishPremiumReview (ReviewPremiumDTO aReview){
        try{
<span class="nc" id="L189">            ReviewPremiumNotification notification = new ReviewPremiumNotification(aReview, &quot;new premium review &quot; );</span>
<span class="nc" id="L190">            template.convertAndSend(MessagingConfig.EXCHANGE, MessagingConfig.ROUTING_KEY, notification);</span>
<span class="nc" id="L191">        }catch (Exception e){</span>
            //nothing to do
<span class="nc" id="L193">        }</span>
<span class="nc" id="L194">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>