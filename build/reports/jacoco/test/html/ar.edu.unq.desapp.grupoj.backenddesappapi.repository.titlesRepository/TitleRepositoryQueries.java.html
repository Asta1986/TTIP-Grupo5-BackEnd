<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TitleRepositoryQueries.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend-desapp-api</a> &gt; <a href="index.source.html" class="el_package">ar.edu.unq.desapp.grupoj.backenddesappapi.repository.titlesRepository</a> &gt; <span class="el_source">TitleRepositoryQueries.java</span></div><h1>TitleRepositoryQueries.java</h1><pre class="source lang-java linenums">package ar.edu.unq.desapp.grupoj.backenddesappapi.repository.titlesRepository;

import ar.edu.unq.desapp.grupoj.backenddesappapi.model.cast.Cast;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.cast.Person;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.Decade;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.Review;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.titles.Genre;
import ar.edu.unq.desapp.grupoj.backenddesappapi.model.titles.Title;
import ar.edu.unq.desapp.grupoj.backenddesappapi.service.dtos.InverseReq;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Repository;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Root;
import javax.persistence.criteria.Join;
import javax.persistence.criteria.Expression;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Subquery;
import javax.persistence.criteria.Path;

import java.util.List;

@Repository
<span class="nc" id="L28">public class TitleRepositoryQueries {</span>


    @PersistenceContext
    EntityManager em;


    public List&lt;Title&gt; inverseQuery(InverseReq req, List&lt;Decade&gt; decades)
    {

<span class="nc" id="L38">        CriteriaBuilder cb = em.getCriteriaBuilder();</span>
<span class="nc" id="L39">        CriteriaQuery&lt;Title&gt; cq = cb.createQuery(Title.class);</span>


<span class="nc" id="L42">        Root&lt;Title&gt; title = cq.from(Title.class);</span>
<span class="nc" id="L43">        Join&lt;Title,Review&gt; joinTitleReviews= title.join(&quot;reviews&quot;);</span>




<span class="nc" id="L48">        Expression&lt;List&lt;Genre&gt;&gt; genreProperty = title.get(&quot;genres&quot;);</span>
<span class="nc" id="L49">        Predicate genrePredicate = cb.conjunction();</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        for(Genre oneGenre: req.genres){</span>
<span class="nc" id="L51">            genrePredicate = cb.and(genrePredicate, cb.isMember(oneGenre, genreProperty));</span>
<span class="nc" id="L52">        }</span>


<span class="nc" id="L55">        Expression&lt;Integer&gt; startYear= title.get(&quot;startYear&quot;);</span>
<span class="nc" id="L56">        Expression&lt;Integer&gt; endYear= title.get(&quot;endYear&quot;);</span>
<span class="nc" id="L57">        Predicate yearPredicate= cb.disjunction();</span>


<span class="nc bnc" id="L60" title="All 2 branches missed.">        for(Decade oneDecade: decades){</span>
<span class="nc" id="L61">            yearPredicate= cb.or(yearPredicate, cb.and(cb.greaterThanOrEqualTo(startYear,oneDecade.getFrom()),</span>
<span class="nc" id="L62">                                                    cb.lessThanOrEqualTo(startYear,oneDecade.getTo())));</span>

<span class="nc" id="L64">            yearPredicate= cb.or(yearPredicate, cb.and(cb.greaterThanOrEqualTo(endYear,oneDecade.getFrom()),</span>
<span class="nc" id="L65">                                                    cb.lessThanOrEqualTo(endYear,oneDecade.getTo())));</span>

<span class="nc" id="L67">        }</span>


        //SubQuery para filtrar los titulos que tienen a los actores que se solicitan

<span class="nc" id="L72">            Subquery&lt;Long&gt; subqueryActors = cq.subquery(Long.class);</span>
<span class="nc" id="L73">            Root&lt;Title&gt; subRootTitle = subqueryActors.from(Title.class);</span>
<span class="nc" id="L74">            Join&lt;Title, Cast&gt; joinCast = subRootTitle.join(&quot;cast&quot;);</span>
<span class="nc" id="L75">            Join&lt;Cast, Person&gt; joinPerson = joinCast.join(&quot;person&quot;);</span>

<span class="nc" id="L77">            Path&lt;Long&gt; idPathToTitle = subRootTitle.get(&quot;titleId&quot;);</span>
<span class="nc" id="L78">            Expression&lt;String&gt; nameProp = joinPerson.get(&quot;name&quot;);</span>

<span class="nc" id="L80">            Predicate predicateD = cb.disjunction();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            for (String oneName : req.actors) {</span>
<span class="nc" id="L82">                predicateD = cb.or(predicateD, cb.like(nameProp, oneName));</span>
<span class="nc" id="L83">            }</span>

<span class="nc" id="L85">            Expression&lt;Long&gt; idCount = cb.count(joinPerson.get(&quot;name&quot;));</span>
<span class="nc" id="L86">            subqueryActors.select(idPathToTitle)</span>
<span class="nc" id="L87">                    .where(predicateD)</span>
<span class="nc" id="L88">                    .groupBy(idPathToTitle)</span>
<span class="nc" id="L89">                    .having(cb.gt(idCount, 0));</span>



        //SubQuery para filtrar los titulos tiene reviews con menos estrellas de las deseadas
<span class="nc" id="L94">        Subquery&lt;Long&gt; subQueryEstrellas = cq.subquery(Long.class);</span>
<span class="nc" id="L95">        Root&lt;Title&gt; subRoot = subQueryEstrellas.from(Title.class);</span>
<span class="nc" id="L96">        Join&lt;Review, Title&gt; join = subRoot.join(&quot;reviews&quot;);</span>
<span class="nc" id="L97">        Path&lt;Long&gt; idPath = join.get(&quot;titleId&quot;);</span>
<span class="nc" id="L98">        Expression&lt;Long&gt; idCountExp = cb.count(join.get(&quot;id&quot;));</span>
<span class="nc" id="L99">        subQueryEstrellas.select(idPath)</span>
<span class="nc" id="L100">                .where(cb.lt(join.get(&quot;rating&quot;),req.minStars))</span>
<span class="nc" id="L101">                .groupBy(idPath)</span>
<span class="nc" id="L102">                .having(cb.gt(idCountExp, 0));</span>


        //Subquery para filtrar los calificados positivamente
<span class="nc" id="L106">        Subquery&lt;Long&gt; subQueryRatedUp = cq.subquery(Long.class);</span>
<span class="nc" id="L107">        Root&lt;Title&gt; subRoot2 = subQueryRatedUp.from(Title.class);</span>
<span class="nc" id="L108">        Join&lt;Review, Title&gt; join2 = subRoot2.join(&quot;reviews&quot;);</span>
<span class="nc" id="L109">        Path&lt;Long&gt; idPath2 = join2.get(&quot;titleId&quot;);</span>
<span class="nc" id="L110">        Expression&lt;Long&gt; rateDiff = cb.diff(join2.get(&quot;ratedUp&quot;),join2.get(&quot;ratedDown&quot;));</span>
<span class="nc" id="L111">        Predicate predicate = cb.lessThan(rateDiff,(long) 0);</span>
<span class="nc" id="L112">        subQueryRatedUp.select(idPath2)</span>
<span class="nc" id="L113">                .where(predicate)</span>
<span class="nc" id="L114">                .groupBy(idPath2);</span>

<span class="nc" id="L116">        Predicate finalConjunction = cb.conjunction();</span>


<span class="nc" id="L119">        finalConjunction= cb.and(finalConjunction,cb.not(title.get(&quot;titleId&quot;).in(subQueryEstrellas)));</span>
<span class="nc" id="L120">        finalConjunction= cb.and(finalConjunction,cb.not(title.get(&quot;titleId&quot;).in(subQueryRatedUp)));</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">        if(!req.decade.isEmpty()) {</span>
<span class="nc" id="L123">            finalConjunction = cb.and(finalConjunction, yearPredicate);</span>
        }

<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (!req.genres.isEmpty()) {</span>
<span class="nc" id="L127">            finalConjunction = cb.and(finalConjunction, genrePredicate);</span>
        }
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if(!req.actors.isEmpty()) {</span>
<span class="nc" id="L130">            finalConjunction = cb.and(finalConjunction, title.get(&quot;titleId&quot;).in(subqueryActors));</span>
        }

<span class="nc" id="L133">        cq.where(finalConjunction );</span>



<span class="nc" id="L137">        TypedQuery&lt;Title&gt; query = em.createQuery(cq);</span>
<span class="nc" id="L138">        return query.getResultList();</span>

    }


}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>